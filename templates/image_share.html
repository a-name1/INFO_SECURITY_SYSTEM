<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾åƒä¿¡æ¯åˆ†å­˜ - ä¿¡æ¯å®‰å…¨æŠ€æœ¯ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="brand">ä¿¡æ¯å®‰å…¨æŠ€æœ¯ç³»ç»Ÿ</div>
            <div class="nav-right">
                <a href="{{ url_for('index') }}">é¦–é¡µ</a>
                <a href="{{ url_for('help_page') }}">ğŸ“š å¸®åŠ©</a>
                <button id="logout-btn">ç™»å‡º</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <h1>å›¾åƒä¿¡æ¯åˆ†å­˜</h1>
        <p>ä½¿ç”¨Shamirç§˜å¯†åˆ†äº«æ–¹æ¡ˆå®ç°å›¾åƒçš„å®‰å…¨åˆ†å­˜ä¸æ¢å¤</p>

        <div class="tabs">
            <button class="tab-btn active" data-tab="split">åˆ†å‰²å›¾åƒ</button>
            <button class="tab-btn" data-tab="recover">æ¢å¤å›¾åƒ</button>
        </div>

        <!-- åˆ†å‰²å›¾åƒ -->
        <div id="split" class="tab-content active">
            <h2>åˆ†å‰²å›¾åƒä¸ºå¤šä¸ªåˆ†ç‰‡</h2>
            <div class="info-box">
                <h4>ğŸ“– Shamirç§˜å¯†åˆ†äº«æ–¹æ¡ˆ</h4>
                <p><strong>åŸç†ï¼š</strong>å°†ä¸€ä¸ªç§˜å¯†åˆ†æˆnä¸ªåˆ†ç‰‡ï¼Œå…¶ä¸­ä»»æ„kä¸ªåˆ†ç‰‡éƒ½å¯ä»¥æ¢å¤åŸç§˜å¯†</p>
                <p><strong>å‚æ•°è¯´æ˜ï¼š</strong>
                    <ul style="margin: 5px 0 5px 20px;">
                        <li><strong>kï¼ˆé˜ˆå€¼ï¼‰ï¼š</strong>æ¢å¤åŸå›¾æ‰€éœ€çš„æœ€å°‘åˆ†ç‰‡æ•°</li>
                        <li><strong>nï¼ˆæ€»æ•°ï¼‰ï¼š</strong>ç”Ÿæˆçš„åˆ†ç‰‡æ€»æ•°</li>
                        <li><strong>å…³ç³»ï¼š</strong>k â‰¤ nï¼Œåªæœ‰ä»»æ„kä¸ªåˆ†ç‰‡å¯æ¢å¤</li>
                    </ul>
                </p>
                <p><strong>å®‰å…¨æ€§ï¼š</strong>
                    <ul style="margin: 5px 0 5px 20px;">
                        <li>æ‹¥æœ‰k-1ä¸ªåˆ†ç‰‡æ— æ³•æ¢å¤åŸå›¾</li>
                        <li>åˆ†ç‰‡è¶Šå¤šï¼Œå®¹é”™èƒ½åŠ›è¶Šå¼º</li>
                        <li>kå€¼è¶Šå°ï¼Œæ¢å¤è¶Šå®¹æ˜“</li>
                    </ul>
                </p>
                <p><strong>åº”ç”¨ï¼š</strong>é‡è¦æ•°æ®å¤‡ä»½ã€å¯†é’¥åˆ†å¸ƒå¼å­˜å‚¨ã€æ–‡ä»¶ä¿æŠ¤</p>
                <p><strong>å…¸å‹é…ç½®ï¼š</strong>k=3, n=5ï¼ˆ5ä¸ªåˆ†ç‰‡ä¸­ä»»æ„3ä¸ªå¯æ¢å¤ï¼‰</p>
            </div>
            <div class="form-group">
                <label for="image-file">é€‰æ‹©å›¾åƒ</label>
                <input type="file" id="image-file" accept="image/*">
                <p style="font-size: 12px; color: #666; margin: 5px 0;">ğŸ“Š è¾“å…¥é™åˆ¶ï¼šæœ€å¤§ 10MB | æ”¯æŒæ ¼å¼ï¼šJPG, PNG, BMP, GIF ç­‰</p>
            </div>
            <div class="form-group">
                <label for="threshold">æ¢å¤æ‰€éœ€åˆ†ç‰‡æ•° (k)</label>
                <input type="number" id="threshold" value="3" min="2" max="10">
                <p style="font-size: 12px; color: #666; margin: 5px 0;">ğŸ’¡ æç¤ºï¼škå€¼è¶Šå°è¶Šå®¹æ˜“æ¢å¤ï¼Œä½†å®‰å…¨æ€§é™ä½ï¼›é€šå¸¸k=3, n=5é…ç½®æœ€ä¼˜</p>
            </div>
            <div class="form-group">
                <label for="shares">æ€»åˆ†ç‰‡æ•° (n)</label>
                <input type="number" id="shares" value="5" min="3" max="10">
                <p style="font-size: 12px; color: #666; margin: 5px 0;">ğŸ“ æ“ä½œæ­¥éª¤ï¼š1.é€‰æ‹©å›¾åƒ â†’ 2.è®¾ç½®kå’Œn â†’ 3.ç‚¹å‡»"åˆ†å‰²å›¾åƒ" â†’ 4.ä¿å­˜æ‰€æœ‰åˆ†ç‰‡æ–‡ä»¶</p>
            </div>
            <button class="btn btn-primary" onclick="splitImage()">åˆ†å‰²å›¾åƒ</button>
            <div id="split-result" class="result"></div>
        </div>

        <!-- æ¢å¤å›¾åƒ -->
        <div id="recover" class="tab-content">
            <h2>ä»åˆ†ç‰‡æ¢å¤å›¾åƒ</h2>
            <div class="info-box">
                <h4>ğŸ“– å›¾åƒæ¢å¤æµç¨‹ï¼ˆè‡ªåŠ¨æ£€æµ‹å‚æ•°ï¼‰</h4>
                <p><strong>å‰ç½®æ¡ä»¶ï¼š</strong>æ‹¥æœ‰è‡³å°‘kä¸ªæœ‰æ•ˆçš„åˆ†ç‰‡æ–‡ä»¶å’Œmetadata.json</p>
                <p><strong>âœ¨ æ–°åŠŸèƒ½ï¼š</strong>ç³»ç»Ÿä¼šè‡ªåŠ¨ä»metadata.jsonè¯»å–å›¾åƒå‚æ•°ï¼Œæ— éœ€æ‰‹åŠ¨è¾“å…¥ï¼</p>
                <p><strong>æ¢å¤æ­¥éª¤ï¼š</strong>
                    <ol style="margin: 5px 0 5px 20px;">
                        <li>é€‰æ‹©è‡³å°‘kä¸ªåˆ†ç‰‡æ–‡ä»¶ï¼ˆshare_*.binï¼‰å’Œmetadata.json</li>
                        <li>ç‚¹å‡»"æ¢å¤å›¾åƒ"æŒ‰é’® - ç³»ç»Ÿè‡ªåŠ¨æ£€æµ‹æ‰€æœ‰å‚æ•°</li>
                        <li>ç­‰å¾…æ¢å¤å®Œæˆå¹¶ä¸‹è½½ç»“æœ</li>
                    </ol>
                </p>
                <p><strong>æ³¨æ„äº‹é¡¹ï¼š</strong>
                    <ul style="margin: 5px 0 5px 20px;">
                        <li>âœ… æ— éœ€è¾“å…¥é˜ˆå€¼kï¼ˆè‡ªåŠ¨ä»metadata.jsonè¯»å–ï¼‰</li>
                        <li>âœ… æ— éœ€è¾“å…¥å›¾åƒå°ºå¯¸ï¼ˆè‡ªåŠ¨ä»metadata.jsonè¯»å–ï¼‰</li>
                        <li>âœ… æ— éœ€æŒ‡å®šå›¾åƒæ ¼å¼ï¼ˆè‡ªåŠ¨ä»metadata.jsonè¯»å–ï¼‰</li>
                        <li>âš ï¸  å¿…é¡»åŒ…å«metadata.jsonæ–‡ä»¶</li>
                        <li>âš ï¸  æ‰€æœ‰åˆ†ç‰‡å¿…é¡»æ¥è‡ªåŒä¸€æ¬¡åˆ†å‰²</li>
                        <li>âš ï¸  åˆ†ç‰‡æ–‡ä»¶ä¸èƒ½æŸå</li>
                    </ul>
                </p>
                <p><strong>æ¢å¤åŸç†ï¼š</strong>ä½¿ç”¨Lagrangeæ’å€¼æ³•ä»åˆ†ç‰‡é‡æ„åŸå§‹æ•°æ®</p>
            </div>
            
            <div class="form-group">
                <label for="share-files">é€‰æ‹©åˆ†ç‰‡æ–‡ä»¶</label>
                <input type="file" id="share-files" multiple accept=".bin,.json">
                <p style="font-size: 12px; color: #666; margin: 5px 0;">ğŸ’¡ æç¤ºï¼šé€‰æ‹©åˆ†ç‰‡æ–‡ä»¶ï¼ˆshare_*.binï¼‰å’Œmetadata.jsonï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ£€æµ‹å‚æ•°</p>
            </div>
            
            <div id="metadata-info" style="display: none; background: #e8f4f8; padding: 10px; margin: 10px 0; border-radius: 4px;">
                <p><strong>ğŸ“„ æ£€æµ‹åˆ°çš„å…ƒæ•°æ®ï¼š</strong></p>
                <p id="metadata-details" style="margin: 5px 0;"></p>
            </div>
            
            <button class="btn btn-primary" onclick="recoverImage()">æ¢å¤å›¾åƒ</button>
            <div id="recover-result" class="result"></div>
        </div>
    </div>

    <script>
        // æ ‡ç­¾é¡µåˆ‡æ¢
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const tabName = this.getAttribute('data-tab');
                document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.getElementById(tabName).classList.add('active');
                this.classList.add('active');
            });
        });

        // ç™»å‡º
        document.getElementById('logout-btn').addEventListener('click', function() {
            fetch('/auth/logout', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.href = '/';
                    }
                });
        });

        // åˆ†å‰²å›¾åƒ
        function splitImage() {
            const imageFile = document.getElementById('image-file').files[0];
            const threshold = document.getElementById('threshold').value;
            const shares = document.getElementById('shares').value;
            
            if (!imageFile) {
                alert('è¯·é€‰æ‹©ä¸€ä¸ªå›¾åƒæ–‡ä»¶');
                return;
            }
            
            if (parseInt(threshold) > parseInt(shares)) {
                alert('æ¢å¤æ‰€éœ€åˆ†ç‰‡æ•°ä¸èƒ½å¤§äºæ€»åˆ†ç‰‡æ•°');
                return;
            }
            
            const formData = new FormData();
            formData.append('image', imageFile);
            formData.append('threshold', threshold);
            formData.append('shares', shares);
            
            document.getElementById('split-result').innerHTML = '<p style="color: blue;">â³ æ­£åœ¨å¤„ç†å›¾åƒ...</p>';
            
            fetch('/api/image/split', {
                method: 'POST',
                body: formData
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    let sharesHtml = '<h3>âœ… åˆ†å‰²æˆåŠŸï¼</h3>';
                    sharesHtml += `<p><strong>æ¶ˆæ¯ï¼š</strong>${data.message}</p>`;
                    sharesHtml += `<div style="background: #f0f8ff; padding: 10px; border-radius: 4px; margin: 10px 0;">`;
                    sharesHtml += `<p><strong>ğŸ“Š åˆ†å‰²ä¿¡æ¯ï¼š</strong></p>`;
                    sharesHtml += `<ul style="margin: 5px 0 5px 20px;">`;
                    sharesHtml += `<li>æ—¶é—´æˆ³: ${data.timestamp}</li>`;
                    sharesHtml += `<li>æ€»åˆ†ç‰‡æ•°: ${data.total_shares}</li>`;
                    sharesHtml += `<li>æ¢å¤é˜ˆå€¼: ${data.threshold}</li>`;
                    sharesHtml += `<li>å›¾åƒæ¨¡å¼: ${data.image_mode}</li>`;
                    sharesHtml += `<li>å›¾åƒå°ºå¯¸: ${data.image_size[0]} Ã— ${data.image_size[1]}</li>`;
                    sharesHtml += `</ul>`;
                    sharesHtml += `</div>`;
                    sharesHtml += `<p><strong>ğŸ“¦ ç”Ÿæˆçš„åˆ†ç‰‡ï¼š</strong></p>`;
                    sharesHtml += `<div style="background: #fff9e6; padding: 10px; border-radius: 4px; margin: 10px 0;">`;
                    sharesHtml += `<ul style="margin: 5px 0 5px 20px;">`;
                    data.shares.forEach((share, index) => {
                        sharesHtml += `<li><code>${share}</code></li>`;
                    });
                    sharesHtml += `</ul>`;
                    sharesHtml += `</div>`;
                    sharesHtml += `<p><strong>ğŸ’¾ é‡è¦æç¤ºï¼š</strong></p>`;
                    sharesHtml += `<ul style="margin: 5px 0 5px 20px;">`;
                    sharesHtml += `<li>âœ… ç³»ç»Ÿå·²è‡ªåŠ¨ç”Ÿæˆ <code>metadata.json</code> æ–‡ä»¶</li>`;
                    sharesHtml += `<li>ğŸ“¥ è¯·ä»æœåŠ¡å™¨ä¸‹è½½æ‰€æœ‰ ${data.total_shares} ä¸ªåˆ†ç‰‡æ–‡ä»¶ï¼ˆæœ¬åœ°è¿è¡Œæ—¶å­˜å‚¨åœ¨outputsæ–‡ä»¶å¤¹ä¸‹ï¼‰</li>`;
                    sharesHtml += `<li>ğŸ“„ åŒæ—¶ä¸‹è½½ <code>metadata.json</code>ï¼Œæ¢å¤æ—¶ä¼šè‡ªåŠ¨ä½¿ç”¨</li>`;
                    sharesHtml += `<li>âœ¨ æ¢å¤æ—¶æ— éœ€æ‰‹åŠ¨è¾“å…¥å‚æ•°ï¼</li>`;
                    sharesHtml += `<li>ğŸ”’ å»ºè®®å°†åˆ†ç‰‡å­˜æ”¾åœ¨ä¸åŒä½ç½®ä»¥æé«˜å®‰å…¨æ€§</li>`;
                    sharesHtml += `</ul>`;
                    document.getElementById('split-result').innerHTML = sharesHtml;
                } else {
                    document.getElementById('split-result').innerHTML = 
                        `<p style="color: red;">âŒ é”™è¯¯: ${data.message}</p>`;
                }
            })
            .catch(error => {
                document.getElementById('split-result').innerHTML = 
                    `<p style="color: red;">âŒ é”™è¯¯: ${error.message}</p>`;
            });
        }

        // æ¢å¤å›¾åƒ
        function recoverImage() {
            const shareFiles = document.getElementById('share-files').files;
            
            if (shareFiles.length === 0) {
                document.getElementById('recover-result').innerHTML = 
                    `<p style="color: red;">âŒ é”™è¯¯: è¯·é€‰æ‹©åˆ†ç‰‡æ–‡ä»¶</p>`;
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å«metadata.json
            let hasMetadata = false;
            for (let i = 0; i < shareFiles.length; i++) {
                if (shareFiles[i].name === 'metadata.json') {
                    hasMetadata = true;
                    break;
                }
            }
            
            if (!hasMetadata) {
                document.getElementById('recover-result').innerHTML = 
                    `<p style="color: orange;">âš ï¸  è­¦å‘Š: æœªæ‰¾åˆ°metadata.jsonï¼Œç³»ç»Ÿä¼šå°è¯•æ¢å¤ä½†å¯èƒ½å¤±è´¥</p>`;
            }
            
            const formData = new FormData();
            for (let i = 0; i < shareFiles.length; i++) {
                formData.append('share_files', shareFiles[i]);
            }
            
            document.getElementById('recover-result').innerHTML = '<p style="color: blue;">â³ æ­£åœ¨æ¢å¤å›¾åƒï¼ˆè‡ªåŠ¨æ£€æµ‹å‚æ•°ï¼‰...</p>';
            
            fetch('/api/image/recover', {
                method: 'POST',
                body: formData
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    const recoverResult = document.getElementById('recover-result');
                    recoverResult.innerHTML = `<h3>âœ… æ¢å¤æˆåŠŸï¼</h3>`;
                    recoverResult.innerHTML += `<p>ç³»ç»Ÿå·²ä»ä¸Šä¼ çš„åˆ†ç‰‡è‡ªåŠ¨æ¢å¤å‡ºåŸå§‹å›¾åƒ</p>`;
                    recoverResult.innerHTML += `<p><strong>è¾“å‡ºæ–‡ä»¶ï¼š</strong> ${data.output_file}</p>`;
                    recoverResult.innerHTML += `<p><a href="${data.download_url}" download class="btn btn-success">ğŸ“¥ ä¸‹è½½æ¢å¤çš„å›¾åƒ</a></p>`;
                } else {
                    document.getElementById('recover-result').innerHTML = `<p style="color: red;">âŒ æ¢å¤å¤±è´¥: ${data.message}</p>`;
                }
            })
            .catch(error => {
                document.getElementById('recover-result').innerHTML = `<p style="color: red;">âŒ é”™è¯¯: ${error.message}</p>`;
            });
        }
    </script>
</body>
</html>
